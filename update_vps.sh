#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≠–∫–æ–ø–∞—Ç—Ä—É–ª—å –Ω–∞ VPS
# –†–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–æ–µ–∫—Ç–æ–º –≤ /var/www/ecopatrol
set -e

PROJECT_ROOT="/var/www/ecopatrol"
echo "üîÑ ========================================"
echo "üîÑ   –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≠–∫–æ–ø–∞—Ç—Ä—É–ª—å –Ω–∞ VPS         "
echo "üîÑ ========================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –Ω–µ–π
cd $PROJECT_ROOT

# 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
echo "üîπ –ü–æ–¥—Ç—è–≥–∏–≤–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git..."
git pull

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üîπ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ Backend..."
cd backend
source venv/bin/activate
pip install -r requirements.txt

# 3. –§–∏–∫—Å localhost -> 127.0.0.1 –≤ .env (–µ—Å–ª–∏ –æ–Ω —Ç–∞–º –æ—Å—Ç–∞–ª—Å—è)
if [ -f .env ]; then
    sed -i "s/localhost/127.0.0.1/g" .env
fi

# 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î
echo "üîπ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
python3 -c "from app import app, db; ctx=app.app_context(); ctx.push(); db.create_all(); ctx.pop()"
deactivate
cd ..

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±
echo "üîπ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
sudo systemctl restart eco-api eco-bot
sudo systemctl restart nginx

echo "‚úÖ ========================================"
echo "‚úÖ   –ü–†–û–ï–ö–¢ –£–°–ü–ï–®–ù–û –û–ë–ù–û–í–õ–ï–ù!            "
echo "‚úÖ ========================================"
