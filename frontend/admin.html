<!doctype html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
		/>
		<title>Eco Admin</title>
		<script src="https://telegram.org/js/telegram-web-app.js"></script>
		<style>
			:root {
				--primary: #10b981;
				--primary-dark: #059669;
				--bg-page: #f9fafb;
				--bg-card: #ffffff;
				--text-main: #111827;
				--text-muted: #6b7280;
				--border: #e5e7eb;
				--safe-top: env(safe-area-inset-top);
			}

			[data-theme='dark'] {
				--bg-page: #111827;
				--bg-card: #1f2937;
				--text-main: #f9fafb;
				--text-muted: #9ca3af;
				--border: #374151;
			}

			* {
				box-sizing: border-box;
				-webkit-tap-highlight-color: transparent;
			}
			body {
				font-family:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				background-color: var(--bg-page);
				color: var(--text-main);
				margin: 0;
				padding: calc(var(--safe-top) + 16px) 16px 40px;
				transition: background-color 0.2s;
				line-height: 1.5;
			}

			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 24px;
			}

			.header h1 {
				font-size: 20px;
				font-weight: 800;
				margin: 0;
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.btn-icon {
				width: 40px;
				height: 40px;
				border-radius: 12px;
				background: var(--bg-card);
				border: 1px solid var(--border);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				color: var(--text-main);
			}

			.tabs {
				display: flex;
				background: var(--bg-card);
				padding: 4px;
				border-radius: 14px;
				margin-bottom: 24px;
				border: 1px solid var(--border);
			}

			.tab-btn {
				flex: 1;
				padding: 10px;
				border: none;
				border-radius: 10px;
				background: transparent;
				color: var(--text-muted);
				font-weight: 700;
				font-size: 13px;
				cursor: pointer;
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 4px;
			}

			.tab-btn.active {
				background: var(--primary);
				color: white;
			}

			.tab-btn svg {
				width: 20px;
				height: 20px;
			}

			.section {
				display: none;
			}
			.section.active {
				display: block;
			}

			/* Stats */
			.stats-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 12px;
				margin-bottom: 24px;
			}
			.stat-card {
				background: var(--bg-card);
				padding: 20px;
				border-radius: 16px;
				border: 1px solid var(--border);
			}
			.stat-label {
				font-size: 11px;
				font-weight: 700;
				color: var(--text-muted);
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 4px;
				display: block;
			}
			.stat-value {
				font-size: 24px;
				font-weight: 800;
			}

			/* Card list */
			.card {
				background: var(--bg-card);
				border-radius: 20px;
				padding: 16px;
				margin-bottom: 16px;
				border: 1px solid var(--border);
			}
			.card-header {
				display: flex;
				justify-content: space-between;
				margin-bottom: 12px;
			}
			.card-title {
				font-weight: 800;
				font-size: 16px;
			}
			.card-meta {
				font-size: 13px;
				color: var(--text-muted);
				font-weight: 500;
				margin-bottom: 12px;
			}

			.user-link {
				display: flex;
				align-items: center;
				gap: 8px;
				margin-bottom: 6px;
				font-size: 14px;
				font-weight: 600;
			}
			.user-link .tg-link {
				color: var(--primary);
				text-decoration: none;
				display: flex;
				align-items: center;
				gap: 4px;
			}

			.gallery {
				display: flex;
				gap: 8px;
				overflow-x: auto;
				margin: 12px 0;
				padding-bottom: 4px;
				scrollbar-width: none;
			}
			.gallery::-webkit-scrollbar {
				display: none;
			}
			.photo-thumb {
				width: 100px;
				height: 100px;
				border-radius: 12px;
				object-fit: cover;
				border: 1px solid var(--border);
				background: var(--bg-page);
				cursor: pointer;
			}

			.btn-row {
				display: flex;
				gap: 8px;
				margin-top: 16px;
			}
			.btn {
				flex: 1;
				padding: 12px;
				border: none;
				border-radius: 12px;
				font-weight: 700;
				font-size: 13px;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 6px;
			}
			.btn-min {
				flex: none;
				width: 44px;
				padding: 10px;
			}
			.btn-solid {
				background: var(--primary);
				color: white;
			}
			.btn-outline {
				background: var(--bg-card);
				color: var(--text-main);
				border: 1px solid var(--border);
			}
			.btn-danger {
				background: #ef4444;
				color: white;
				border: 1px solid #ef4444;
			}
			[data-theme='dark'] .btn-danger {
				background: rgba(220, 38, 38, 0.2);
				border-color: rgba(220, 38, 38, 0.3);
			}

			/* Photo Viewer - Implementation Plan: Modal style like index.html */
			.photo-viewer {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.9);
				z-index: 1000;
				display: none;
				align-items: center;
				justify-content: center;
				opacity: 0;
				transition: opacity 0.3s ease;
			}
			.photo-viewer.active {
				display: flex;
				opacity: 1;
			}
			.viewer-img {
				max-width: 95%;
				max-height: 95%;
				border-radius: 8px;
				object-fit: contain;
			}
			.close-viewer {
				position: absolute;
				top: calc(env(safe-area-inset-top) + 16px);
				right: 16px;
				width: 44px;
				height: 44px;
				background: white;
				color: black;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 24px;
				font-weight: bold;
				cursor: pointer;
			}

			.settings-card {
				background: var(--bg-card);
				border-radius: 20px;
				padding: 20px;
				border: 1px solid var(--border);
			}
			.input-group {
				margin-bottom: 16px;
			}
			.input-label {
				display: block;
				font-size: 12px;
				font-weight: 700;
				color: var(--text-muted);
				margin-bottom: 6px;
			}
			.input-field {
				width: 100%;
				background: var(--bg-page);
				border: 1.5px solid var(--border);
				border-radius: 12px;
				padding: 12px;
				color: var(--text-main);
				font-weight: 600;
				font-size: 15px;
				outline: none;
			}
			.input-field:focus {
				border-color: var(--primary);
			}

			.loading {
				text-align: center;
				padding: 60px 0;
				color: var(--text-muted);
				font-weight: 600;
			}
			.status-badge {
				display: inline-block;
				padding: 2px 8px;
				border-radius: 6px;
				font-size: 10px;
				font-weight: 800;
				text-transform: uppercase;
			}
			.status-active {
				background: rgba(16, 185, 129, 0.1);
				color: var(--primary);
			}
			.status-cleaned {
				background: rgba(59, 130, 246, 0.1);
				color: #3b82f6;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>
				<svg
					width="24"
					height="24"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2.5"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
				</svg>
				Eco Admin
			</h1>
			<div class="btn-icon" onclick="toggleTheme()" id="theme-btn">
				<svg
					id="sun-icon"
					style="display: none"
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<circle cx="12" cy="12" r="5" />
					<line x1="12" y1="1" x2="12" y2="3" />
					<line x1="12" y1="21" x2="12" y2="23" />
					<line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
					<line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
					<line x1="1" y1="12" x2="3" y2="12" />
					<line x1="21" y1="12" x2="23" y2="12" />
					<line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
					<line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
				</svg>
				<svg
					id="moon-icon"
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
				</svg>
			</div>
		</div>

		<div class="tabs">
			<button class="tab-btn active" onclick="switchTab('dashboard', this)">
				<svg
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<rect x="3" y="3" width="7" height="7" />
					<rect x="14" y="3" width="7" height="7" />
					<rect x="14" y="14" width="7" height="7" />
					<rect x="3" y="14" width="7" height="7" />
				</svg>
				<span>Обзор</span>
			</button>
			<button class="tab-btn" onclick="switchTab('users', this)">
				<svg
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
					<circle cx="9" cy="7" r="4" />
					<path d="M23 21v-2a4 4 0 0 0-3-3.87" />
					<path d="M16 3.13a4 4 0 0 1 0 7.75" />
				</svg>
				<span>Люди</span>
			</button>
			<button class="tab-btn" onclick="switchTab('pollutions', this)">
				<svg
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
					<circle cx="12" cy="10" r="3" />
				</svg>
				<span>Список</span>
			</button>
			<button class="tab-btn" onclick="switchTab('settings', this)">
				<svg
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<circle cx="12" cy="12" r="3" />
					<path
						d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
					/>
				</svg>
				<span>Настройки</span>
			</button>
		</div>

		<!-- SECTIONS -->
		<div id="section-dashboard" class="section active">
			<div id="stats-loader" class="loading">Загрузка статистики...</div>
			<div id="stats-content" class="stats-grid" style="display: none">
				<div class="stat-card">
					<span class="stat-label">Люди</span
					><span class="stat-value" id="st-users">0</span>
				</div>
				<div class="stat-card">
					<span class="stat-label">На карте</span
					><span class="stat-value" id="st-active">0</span>
				</div>
				<div class="stat-card">
					<span class="stat-label">Очищено</span
					><span class="stat-value" id="st-cleaned">0</span>
				</div>
				<div class="stat-card">
					<span class="stat-label">Выплаты</span
					><span class="stat-value" id="st-rewards">0 UZS</span>
				</div>
			</div>
		</div>

		<div id="section-users" class="section">
			<div style="margin-bottom: 16px">
				<input
					type="text"
					id="user-search"
					class="input-field"
					placeholder="Search by name, username, or phone..."
					onkeyup="filterUsers()"
					style="margin-bottom: 0"
				/>
			</div>
			<div id="users-list"></div>
		</div>

		<div id="section-pollutions" class="section">
			<div id="pollutions-list"></div>
		</div>

		<div id="section-settings" class="section">
			<div class="settings-card">
				<div class="input-group">
					<label class="input-label">Награда Уровень 1</label>
					<input type="number" id="set-1" class="input-field" />
				</div>
				<div class="input-group">
					<label class="input-label">Награда Уровень 2</label>
					<input type="number" id="set-2" class="input-field" />
				</div>
				<div class="input-group">
					<label class="input-label">Награда Уровень 3</label>
					<input type="number" id="set-3" class="input-field" />
				</div>
				<label
					class="input-group"
					style="
						display: flex;
						align-items: center;
						gap: 10px;
						cursor: pointer;
						padding: 10px 0;
					"
				>
					<input
						type="checkbox"
						id="set-debug"
						style="width: 20px; height: 20px; cursor: pointer"
					/>
					<span
						style="font-weight: 700; color: var(--text-main); font-size: 14px"
						>Включить кнопку логов (Debug)</span
					>
				</label>
				<button
					class="btn btn-solid"
					onclick="saveSettings()"
					style="margin-top: 10px"
				>
					Сохранить настройки
				</button>
			</div>
		</div>

		<!-- PHOTO VIEWER LIGHTBOX -->
		<div id="photo-viewer" class="photo-viewer" onclick="closePhotoViewer()">
			<div class="close-viewer" onclick="closePhotoViewer()">×</div>
			<img
				src=""
				id="viewer-img"
				class="viewer-img"
				onclick="event.stopPropagation()"
			/>
		</div>

		<script>
			const tg = window.Telegram.WebApp
			tg.expand()
			const API_URL = window.location.origin + '/api'
			const urlParams = new URLSearchParams(window.location.search)
			const adminTgId = urlParams.get('admin_tg_id')

			const TYPE_LABELS = {
				plastic: 'Пластик',
				glass: 'Стекло',
				paper: 'Бумага',
				metal: 'Металл',
				organic: 'Органика',
				construction: 'Стройотходы',
				electronic: 'Электроника',
				tires: 'Шины',
				hazardous: 'Опасные отходы',
				bulky: 'Крупногабаритный мусор',
				chemical: 'Химические отходы',
				other: 'Прочее',
				trash: 'Прочее',
			}

			function getLocalizedTypes(types) {
				if (!types) return '<i>Тип не указан</i>'
				if (typeof types === 'string') {
					// Handle comma separated string if that's what backend sends
					return types
						.split(',')
						.map(t => t.trim())
						.map(t => TYPE_LABELS[t] || t)
						.join(', ')
				}
				if (Array.isArray(types)) {
					return types.map(t => TYPE_LABELS[t] || t).join(', ')
				}
				return types
			}

			let currentTheme =
				localStorage.getItem('admin-theme') || tg.colorScheme || 'light'
			applyTheme(currentTheme)

			function applyTheme(t) {
				document.documentElement.setAttribute('data-theme', t)
				localStorage.setItem('admin-theme', t)
				document.getElementById('sun-icon').style.display =
					t === 'dark' ? 'block' : 'none'
				document.getElementById('moon-icon').style.display =
					t === 'dark' ? 'none' : 'block'
				tg.setHeaderColor(t === 'dark' ? '#111827' : '#f9fafb')
			}

			function toggleTheme() {
				currentTheme = currentTheme === 'dark' ? 'light' : 'dark'
				applyTheme(currentTheme)
				tg.HapticFeedback.impactOccurred('light')
			}

			function openPhotoViewer(url) {
				const viewer = document.getElementById('photo-viewer')
				const img = document.getElementById('viewer-img')
				img.src = url
				viewer.classList.add('active')
				tg.HapticFeedback.impactOccurred('medium')
			}

			function closePhotoViewer() {
				document.getElementById('photo-viewer').classList.remove('active')
			}

			function switchTab(tab, btn) {
				document
					.querySelectorAll('.section')
					.forEach(s => s.classList.remove('active'))
				document
					.querySelectorAll('.tab-btn')
					.forEach(b => b.classList.remove('active'))
				document.getElementById('section-' + tab).classList.add('active')
				btn.classList.add('active')
				tg.HapticFeedback.impactOccurred('light')

				if (tab === 'dashboard') loadStats()
				if (tab === 'users') loadUsers()
				if (tab === 'pollutions') loadPollutions()
				if (tab === 'settings') loadSettings()
			}

			async function apiFetch(path, options = {}) {
				try {
					// Ensure options.body is handled if present
					const fetchOptions = { ...options }
					const res = await fetch(
						API_URL +
							path +
							(path.includes('?') ? '&' : '?') +
							`admin_tg_id=${adminTgId}`,
						fetchOptions,
					)
					if (!res.ok) throw new Error('API Error')
					return await res.json()
				} catch (e) {
					console.error(e)
					tg.showAlert('Ошибка: проверьте консоль')
					return null
				}
			}

			async function loadStats() {
				const data = await apiFetch('/admin/stats')
				if (!data) return
				document.getElementById('stats-loader').style.display = 'none'
				document.getElementById('stats-content').style.display = 'grid'
				document.getElementById('st-users').innerText = data.total_users
				document.getElementById('st-active').innerText = data.active_pollutions
				document.getElementById('st-cleaned').innerText =
					data.cleaned_pollutions
				document.getElementById('st-rewards').innerText =
					data.total_rewards.toFixed(0) + ' UZS'
			}

			let allUsers = [] // Store for filtering

			async function loadUsers() {
				const list = document.getElementById('users-list')
				list.innerHTML = '<div class="loading">Загрузка...</div>'
				const users = await apiFetch('/admin/users')
				if (!users) return

				allUsers = users // Store globally
				renderUsers(users)
			}

			function renderUsers(users) {
				const list = document.getElementById('users-list')
				list.innerHTML = users
					.map(
						u => `
                <div class="card user-card" data-user-id="${u.id}">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${u.first_name || 'Hero'}</div>
                            <div class="card-meta">@${u.username || '—'} • ${u.phone || 'No phone'}</div>
                        </div>
                        <div style="font-weight:800; color:var(--primary); font-size:17px">${u.balance.toFixed(0)} UZS</div>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-solid" onclick="notifyUser(${u.telegram_id})">
                             <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                             Message
                        </button>
                        <button class="btn btn-outline" onclick="editBalance(${u.id}, ${u.balance})">Balance</button>
                        <button class="btn btn-danger" onclick="deleteUser(${u.id}, '${u.first_name || 'User'}')">
                             <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                             Delete
                        </button>
                    </div>
                </div>
            `,
					)
					.join('')
			}

			function filterUsers() {
				const search = document
					.getElementById('user-search')
					.value.toLowerCase()
				if (!search) {
					renderUsers(allUsers)
					return
				}

				const filtered = allUsers.filter(u => {
					const name = (u.first_name || '').toLowerCase()
					const username = (u.username || '').toLowerCase()
					const phone = (u.phone || '').toLowerCase()
					return (
						name.includes(search) ||
						username.includes(search) ||
						phone.includes(search)
					)
				})

				renderUsers(filtered)
			}

			async function deleteUser(userId, userName) {
				if (
					!confirm(
						`Are you sure you want to delete user "${userName}"?\n\nThis will permanently delete:\n- User account\n- All their pollution reports\n- All related photos\n\nThis action cannot be undone.`,
					)
				) {
					return
				}

				try {
					const res = await fetch(
						`${API_URL}/admin/users/${userId}?admin_tg_id=${adminTgId}`,
						{
							method: 'DELETE',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ admin_tg_id: adminTgId }),
						},
					)

					if (!res.ok) {
						const error = await res.json()
						throw new Error(error.error || 'Delete failed')
					}

					const result = await res.json()
					tg.showAlert(`User "${userName}" deleted successfully`)
					tg.HapticFeedback.notificationOccurred('success')
					loadUsers() // Refresh list
				} catch (e) {
					console.error('Delete error:', e)
					tg.showAlert('Error: ' + e.message)
					tg.HapticFeedback.notificationOccurred('error')
				}
			}

			async function loadPollutions() {
				const list = document.getElementById('pollutions-list')
				list.innerHTML = '<div class="loading">Загрузка...</div>'
				const pollutions = await apiFetch('/admin/pollutions')
				if (!pollutions) {
					list.innerHTML = '<div class="loading">Нет данных</div>'
					return
				}

				list.innerHTML =
					pollutions
						.map(
							p => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px">
                        <span style="font-weight:800; font-size:13px; color:var(--text-muted)">МЕТКА #${p.id}</span>
                        <span class="status-badge ${p.status === 'active' ? 'status-active' : 'status-cleaned'}">${p.status}</span>
                    </div>
                    
                    <div class="user-link">
                        <span>Автор:</span>
                        <span class="tg-link" onclick="notifyUser(${p.creator_tg_id})">
                            ${p.creator_name} <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        </span>
                    </div>
                    
                    ${
											p.cleaner_name ?
												`
                    <div class="user-link">
                        <span>Убрал:</span>
                        <span class="tg-link" onclick="notifyUser(${p.cleaner_tg_id})">
                            ${p.cleaner_name} <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        </span>
                    </div>`
											:	''
										}

                    <div class="card-meta">
                        <div>Уровень ${p.level} • Reward: ${p.reward} UZS</div>
                        <div style="color:var(--primary); font-weight:700; margin-top:4px">${getLocalizedTypes(p.types)}</div>
                    </div>
                    <div style="font-size:14px; margin-bottom:8px">${p.description || '<i>Описание отсутствует</i>'}</div>
                    <div class="gallery">
                        ${(p.photos || []).map(url => `<img src="${url}" class="photo-thumb" onclick="openPhotoViewer('${url}')">`).join('')}
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-outline" onclick="editReward(${p.id}, ${p.reward})">Награда</button>
                        <button class="btn btn-danger btn-min" onclick="deletePollution(${p.id})">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `,
						)
						.join('') || '<div class="loading">Пусто</div>'
			}

			async function loadSettings() {
				const s = await apiFetch('/admin/settings')
				if (s) {
					document.getElementById('set-1').value = s.reward_level_1
					document.getElementById('set-2').value = s.reward_level_2
					document.getElementById('set-3').value = s.reward_level_3
					document.getElementById('set-debug').checked =
						s.debug_logs_enabled === 'true'
				}
			}

			async function saveSettings() {
				const settings = {
					reward_level_1: document.getElementById('set-1').value,
					reward_level_2: document.getElementById('set-2').value,
					reward_level_3: document.getElementById('set-3').value,
					debug_logs_enabled:
						document.getElementById('set-debug').checked ? 'true' : 'false',
				}
				const res = await apiFetch('/admin/settings', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ settings }),
				})
				if (res) tg.showAlert('Настройки сохранены')
			}

			async function notifyUser(userId) {
				if (!userId) {
					tg.showAlert('ID юзера не найден')
					return
				}
				const msg = prompt('Текст сообщения:')
				if (!msg) return
				const res = await apiFetch('/admin/notify', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ target_tg_id: userId, message: msg }),
				})
				if (res && res.status === 'ok') tg.showAlert('Отправлено')
				else if (res) tg.showAlert('Ошибка: ' + res.message)
			}

			async function editBalance(id, curr) {
				const v = prompt('Новый баланс:', curr)
				if (v === null || isNaN(v)) return
				const res = await apiFetch(`/admin/users/${id}/balance`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ balance: parseFloat(v) }),
				})
				if (res) loadUsers()
			}

			async function editReward(id, curr) {
				const v = prompt('Новая награда:', curr)
				if (v === null || isNaN(v)) return
				const res = await apiFetch(`/admin/pollutions/${id}/reward`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ reward: parseFloat(v) }),
				})
				if (res) loadPollutions()
			}

			async function deletePollution(id) {
				if (!confirm('Удалить метку навсегда?')) return
				const res = await apiFetch(`/admin/pollutions/${id}`, {
					method: 'DELETE',
				})
				if (res) loadPollutions()
			}

			loadStats()
		</script>
	</body>
</html>
