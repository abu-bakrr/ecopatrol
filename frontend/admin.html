<!doctype html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
		/>
		<title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å EcoPatrol</title>
		<script src="https://telegram.org/js/telegram-web-app.js"></script>
		<style>
			:root {
				--primary: #10b981;
				--primary-dark: #059669;
				--bg-primary: #f3f4f6;
				--bg-secondary: #ffffff;
				--text-primary: #111827;
				--text-secondary: #4b5563;
				--border: #e5e7eb;
				--safe-top: env(safe-area-inset-top);
			}

			[data-theme='dark'] {
				--bg-primary: #111827;
				--bg-secondary: #1f2937;
				--text-primary: #f9fafb;
				--text-secondary: #9ca3af;
				--border: #374151;
			}

			* {
				box-sizing: border-box;
				-webkit-tap-highlight-color: transparent;
			}

			body {
				font-family:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica,
					Arial, sans-serif;
				background-color: var(--bg-primary);
				color: var(--text-primary);
				margin: 0;
				padding: calc(var(--safe-top) + 20px) 16px 40px;
				transition: background-color 0.2s;
				line-height: 1.4;
			}

			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
			}

			.header h1 {
				font-size: 22px;
				font-weight: 700;
				margin: 0;
				color: var(--primary);
			}

			.theme-toggle {
				width: 38px;
				height: 38px;
				border-radius: 10px;
				background: var(--bg-secondary);
				border: 1px solid var(--border);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
			}

			.tabs {
				display: flex;
				background: var(--bg-secondary);
				padding: 4px;
				border-radius: 12px;
				margin-bottom: 20px;
				border: 1px solid var(--border);
			}

			.tab-btn {
				flex: 1;
				padding: 8px;
				border: none;
				border-radius: 8px;
				background: transparent;
				color: var(--text-secondary);
				font-weight: 600;
				font-size: 13px;
				cursor: pointer;
			}

			.tab-btn.active {
				background: var(--primary);
				color: white;
			}

			.section {
				display: none;
			}
			.section.active {
				display: block;
			}

			.stats-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 12px;
				margin-bottom: 20px;
			}

			.stat-card {
				background: var(--bg-secondary);
				padding: 16px;
				border-radius: 14px;
				border: 1px solid var(--border);
			}

			.stat-val {
				font-size: 20px;
				font-weight: 800;
				display: block;
				margin-bottom: 4px;
			}

			.stat-label {
				font-size: 11px;
				color: var(--text-secondary);
				text-transform: uppercase;
				font-weight: 600;
				letter-spacing: 0.5px;
			}

			.card {
				background: var(--bg-secondary);
				border-radius: 16px;
				padding: 16px;
				margin-bottom: 12px;
				border: 1px solid var(--border);
			}

			.card-header {
				display: flex;
				justify-content: space-between;
				margin-bottom: 10px;
			}

			.name {
				font-weight: 700;
				font-size: 16px;
			}
			.meta {
				font-size: 12px;
				color: var(--text-secondary);
				margin-top: 2px;
			}

			.gallery {
				display: flex;
				gap: 8px;
				overflow-x: auto;
				margin: 10px 0;
				padding-bottom: 4px;
				scrollbar-width: none;
			}

			.gallery::-webkit-scrollbar {
				display: none;
			}

			.photo {
				width: 80px;
				height: 80px;
				border-radius: 8px;
				object-fit: cover;
				flex-shrink: 0;
				border: 1px solid var(--border);
			}

			.btn-group {
				display: flex;
				gap: 8px;
				margin-top: 12px;
			}

			.btn {
				flex: 1;
				padding: 10px;
				border: none;
				border-radius: 10px;
				font-weight: 700;
				font-size: 12px;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 4px;
			}

			.btn-primary {
				background: var(--primary);
				color: white;
			}
			.btn-secondary {
				background: var(--bg-primary);
				color: var(--text-primary);
				border: 1px solid var(--border);
			}
			.btn-danger {
				background: #fee2e2;
				color: #ef4444;
			}

			.settings-item {
				background: var(--bg-secondary);
				padding: 14px;
				border-radius: 12px;
				border: 1px solid var(--border);
				margin-bottom: 10px;
			}

			.label {
				display: block;
				font-size: 12px;
				font-weight: 700;
				margin-bottom: 6px;
				color: var(--text-secondary);
			}
			.input {
				width: 100%;
				padding: 10px;
				border-radius: 8px;
				border: 1px solid var(--border);
				background: var(--bg-primary);
				color: var(--text-primary);
				font-size: 14px;
				outline: none;
			}

			.loading {
				text-align: center;
				padding: 40px;
				opacity: 0.5;
				font-size: 14px;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>Eco Admin</h1>
			<div class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</div>
		</div>

		<div class="tabs">
			<button class="tab-btn active" onclick="switchTab('dashboard', this)">
				–û–±–∑–æ—Ä
			</button>
			<button class="tab-btn" onclick="switchTab('users', this)">–õ—é–¥–∏</button>
			<button class="tab-btn" onclick="switchTab('pollutions', this)">
				–ö–∞—Ä—Ç–∞
			</button>
			<button class="tab-btn" onclick="switchTab('settings', this)">‚öôÔ∏è</button>
		</div>

		<!-- DASHBOARD -->
		<div id="section-dashboard" class="section active">
			<div id="stats-container" class="stats-grid">
				<div class="stat-card">
					<span class="stat-val">‚Äî</span><span class="stat-label">–õ—é–¥–∏</span>
				</div>
				<div class="stat-card">
					<span class="stat-val">‚Äî</span
					><span class="stat-label">–ù–∞ –∫–∞—Ä—Ç–µ</span>
				</div>
				<div class="stat-card">
					<span class="stat-val">‚Äî</span><span class="stat-label">–û—á–∏—â–µ–Ω–æ</span>
				</div>
				<div class="stat-card">
					<span class="stat-val">‚Äî</span><span class="stat-label">–í—ã–ø–ª–∞—Ç—ã</span>
				</div>
			</div>
		</div>

		<!-- USERS -->
		<div id="section-users" class="section">
			<div id="users-list"></div>
		</div>

		<!-- POLLUTIONS -->
		<div id="section-pollutions" class="section">
			<div id="pollutions-list"></div>
		</div>

		<!-- SETTINGS -->
		<div id="section-settings" class="section">
			<div class="settings-item">
				<label class="label">–ù–∞–≥—Ä–∞–¥–∞ –£—Ä–æ–≤–µ–Ω—å 1</label>
				<input type="number" id="set-reward-1" class="input" />
			</div>
			<div class="settings-item">
				<label class="label">–ù–∞–≥—Ä–∞–¥–∞ –£—Ä–æ–≤–µ–Ω—å 2</label>
				<input type="number" id="set-reward-2" class="input" />
			</div>
			<div class="settings-item">
				<label class="label">–ù–∞–≥—Ä–∞–¥–∞ –£—Ä–æ–≤–µ–Ω—å 3</label>
				<input type="number" id="set-reward-3" class="input" />
			</div>
			<button
				class="btn btn-primary"
				style="width: 100%"
				onclick="saveSettings()"
			>
				üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—ã
			</button>
		</div>

		<script>
			const tg = window.Telegram.WebApp
			tg.expand()
			const API_URL = window.location.origin + '/api'
			const urlParams = new URLSearchParams(window.location.search)
			const adminTgId = urlParams.get('admin_tg_id')

			let currentTheme =
				localStorage.getItem('admin-theme') || tg.colorScheme || 'light'
			applyTheme(currentTheme)

			function applyTheme(t) {
				document.documentElement.setAttribute('data-theme', t)
				localStorage.setItem('admin-theme', t)
				document.getElementById('theme-btn').innerText =
					t === 'dark' ? '‚òÄÔ∏è' : 'üåô'
				tg.setHeaderColor(t === 'dark' ? '#111827' : '#f3f4f6')
			}

			function toggleTheme() {
				currentTheme = currentTheme === 'dark' ? 'light' : 'dark'
				applyTheme(currentTheme)
				tg.HapticFeedback.impactOccurred('light')
			}

			function switchTab(tab, btn) {
				document
					.querySelectorAll('.section')
					.forEach(s => s.classList.remove('active'))
				document
					.querySelectorAll('.tab-btn')
					.forEach(b => b.classList.remove('active'))
				document.getElementById('section-' + tab).classList.add('active')
				btn.classList.add('active')
				tg.HapticFeedback.impactOccurred('light')

				if (tab === 'dashboard') loadStats()
				if (tab === 'users') loadUsers()
				if (tab === 'pollutions') loadPollutions()
				if (tab === 'settings') loadSettings()
			}

			async function loadStats() {
				const container = document.getElementById('stats-container')
				try {
					const res = await fetch(
						`${API_URL}/admin/stats?admin_tg_id=${adminTgId}`,
					)
					const s = await res.json()
					container.innerHTML = `
                    <div class="stat-card"><span class="stat-val">${s.total_users}</span><span class="stat-label">–õ—é–¥–∏</span></div>
                    <div class="stat-card"><span class="stat-val">${s.active_pollutions}</span><span class="stat-label">–ù–∞ –∫–∞—Ä—Ç–µ</span></div>
                    <div class="stat-card"><span class="stat-val">${s.cleaned_pollutions}</span><span class="stat-label">–û—á–∏—â–µ–Ω–æ</span></div>
                    <div class="stat-card"><span class="stat-val">$${s.total_rewards.toFixed(1)}</span><span class="stat-label">–í—ã–ø–ª–∞—Ç—ã</span></div>
                `
				} catch (e) {}
			}

			async function loadUsers() {
				const list = document.getElementById('users-list')
				list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>'
				const res = await fetch(
					`${API_URL}/admin/users?admin_tg_id=${adminTgId}`,
				)
				const users = await res.json()
				list.innerHTML = users
					.map(
						u => `
                <div class="card">
                    <div class="card-header">
                        <div><div class="name">${u.first_name}</div><div class="meta">@${u.username || '‚Äî'} ‚Ä¢ ${u.phone || '–ù–µ—Ç –Ω–æ–º–µ—Ä–∞'}</div></div>
                        <div style="font-weight:800; color:var(--primary)">$${u.balance.toFixed(1)}</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="notifyUser(${u.telegram_id})">‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ</button>
                        <button class="btn btn-secondary" onclick="editBalance(${u.id}, ${u.balance})">üí∞ –ë–∞–ª–∞–Ω—Å</button>
                    </div>
                </div>
            `,
					)
					.join('')
			}

			async function loadPollutions() {
				const list = document.getElementById('pollutions-list')
				list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>'
				const res = await fetch(
					`${API_URL}/admin/pollutions?admin_tg_id=${adminTgId}`,
				)
				const pollutions = await res.json()
				list.innerHTML = pollutions
					.map(
						p => `
                <div class="card">
                    <div class="name">–ú–µ—Ç–∫–∞ #${p.id} ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å ${p.level}</div>
                    <div class="meta">${p.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                    <div class="gallery">
                        ${p.photos.map(url => `<img src="${url}" class="photo" onclick="window.open('${url}')">`).join('')}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="editReward(${p.id}, ${p.reward})">üíé $${p.reward}</button>
                        <button class="btn btn-danger" onclick="deletePollution(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `,
					)
					.join('')
			}

			async function loadSettings() {
				const res = await fetch(
					`${API_URL}/admin/settings?admin_tg_id=${adminTgId}`,
				)
				const s = await res.json()
				document.getElementById('set-reward-1').value = s.reward_level_1
				document.getElementById('set-reward-2').value = s.reward_level_2
				document.getElementById('set-reward-3').value = s.reward_level_3
			}

			async function saveSettings() {
				const settings = {
					reward_level_1: document.getElementById('set-reward-1').value,
					reward_level_2: document.getElementById('set-reward-2').value,
					reward_level_3: document.getElementById('set-reward-3').value,
				}
				await fetch(`${API_URL}/admin/settings`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ admin_tg_id: adminTgId, settings }),
				})
				tg.showAlert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!')
			}

			async function notifyUser(userId) {
				const msg = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:')
				if (!msg) return
				const res = await fetch(`${API_URL}/admin/notify`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						admin_tg_id: adminTgId,
						target_tg_id: userId,
						message: msg,
					}),
				})
				if (res.ok) tg.showAlert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!')
			}

			async function editBalance(id, curr) {
				const v = prompt('–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:', curr)
				if (v === null) return
				await fetch(`${API_URL}/admin/users/${id}/balance`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						admin_tg_id: adminTgId,
						balance: parseFloat(v),
					}),
				})
				loadUsers()
			}

			async function editReward(id, curr) {
				const v = prompt('–ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞:', curr)
				if (v === null) return
				await fetch(`${API_URL}/admin/pollutions/${id}/reward`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						admin_tg_id: adminTgId,
						reward: parseFloat(v),
					}),
				})
				loadPollutions()
			}

			async function deletePollution(id) {
				if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return
				await fetch(
					`${API_URL}/admin/pollutions/${id}?admin_tg_id=${adminTgId}`,
					{ method: 'DELETE' },
				)
				loadPollutions()
			}

			loadStats()
		</script>
	</body>
</html>
