<!doctype html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å EcoPatrol</title>
		<script src="https://telegram.org/js/telegram-web-app.js"></script>
		<style>
			:root {
				--primary: #059669;
				--bg: #f3f4f6;
				--card: #ffffff;
				--text: #1f2937;
				--border: #e5e7eb;
			}

			[data-theme='dark'] {
				--bg: #111827;
				--card: #1f2937;
				--text: #f9fafb;
				--border: #374151;
			}

			body {
				font-family: -apple-system, system-ui, sans-serif;
				background: var(--bg);
				color: var(--text);
				margin: 0;
				padding: 16px;
			}

			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 24px;
			}

			.tab-buttons {
				display: flex;
				gap: 8px;
				margin-bottom: 20px;
			}

			.tab-btn {
				flex: 1;
				padding: 10px;
				border: none;
				border-radius: 12px;
				background: var(--card);
				color: var(--text);
				font-weight: 600;
				cursor: pointer;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}

			.tab-btn.active {
				background: var(--primary);
				color: white;
			}

			.section {
				display: none;
			}
			.section.active {
				display: block;
			}

			.card {
				background: var(--card);
				border-radius: 16px;
				padding: 16px;
				margin-bottom: 12px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
				border: 1px solid var(--border);
			}

			.card-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: 8px;
			}

			.name {
				font-weight: 700;
				font-size: 16px;
			}
			.id {
				font-size: 12px;
				opacity: 0.6;
			}
			.balance {
				color: var(--primary);
				font-weight: 700;
			}

			.actions {
				display: flex;
				gap: 8px;
				margin-top: 12px;
			}

			button.action-btn {
				padding: 6px 12px;
				border: none;
				border-radius: 8px;
				font-size: 12px;
				font-weight: 600;
				cursor: pointer;
			}

			.btn-edit {
				background: #3b82f6;
				color: white;
			}
			.btn-delete {
				background: #ef4444;
				color: white;
			}

			.loading {
				text-align: center;
				padding: 40px;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1 style="font-size: 20px; margin: 0">–ü–∞–Ω–µ–ª—å –®–µ—Ñ–∞ üõ†Ô∏è</h1>
		</div>

		<div class="tab-buttons">
			<button class="tab-btn active" onclick="showTab('users')">–õ—é–¥–∏</button>
			<button class="tab-btn" onclick="showTab('pollutions')">–ú—É—Å–æ—Ä</button>
		</div>

		<div id="users-section" class="section active">
			<div id="users-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
		</div>

		<div id="pollutions-section" class="section">
			<div id="pollutions-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–π...</div>
		</div>

		<script>
			const tg = window.Telegram.WebApp
			tg.expand()
			const API_URL = window.location.origin + '/api'
			const urlParams = new URLSearchParams(window.location.search)
			const adminTgId = urlParams.get('admin_tg_id')

			function showTab(tab) {
				document
					.querySelectorAll('.section')
					.forEach(s => s.classList.remove('active'))
				document
					.querySelectorAll('.tab-btn')
					.forEach(b => b.classList.remove('active'))
				document.getElementById(tab + '-section').classList.add('active')
				event.target.classList.add('active')

				if (tab === 'users') loadUsers()
				if (tab === 'pollutions') loadPollutions()
			}

			async function loadUsers() {
				const list = document.getElementById('users-list')
				try {
					const res = await fetch(
						`${API_URL}/admin/users?admin_tg_id=${adminTgId}`,
					)
					const users = await res.json()

					list.innerHTML = users
						.map(
							u => `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="name">${u.first_name} ${u.last_name || ''}</div>
                                <div class="id">@${u.username || 'no_username'} ‚Ä¢ ID: ${u.telegram_id}</div>
                            </div>
                            <div class="balance">$${u.balance}</div>
                        </div>
                        <div class="actions">
                            <button class="action-btn btn-edit" onclick="editBalance(${u.id}, ${u.balance})">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                        </div>
                    </div>
                `,
						)
						.join('')
				} catch (e) {
					list.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
				}
			}

			async function loadPollutions() {
				const list = document.getElementById('pollutions-list')
				try {
					const res = await fetch(
						`${API_URL}/admin/pollutions?admin_tg_id=${adminTgId}`,
					)
					const pollutions = await res.json()

					list.innerHTML = pollutions
						.map(
							p => `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="name">–¢–∏–ø: ${p.types}</div>
                                <div class="id">ID: ${p.id} ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: ${p.level}</div>
                                <div class="id">–°—Ç–∞—Ç—É—Å: ${p.status}</div>
                            </div>
                        </div>
                        <p style="font-size: 13px; margin: 8px 0;">${p.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <div class="actions">
                            <button class="action-btn btn-delete" onclick="deletePollution(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `,
						)
						.join('')
				} catch (e) {
					list.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
				}
			}

			async function editBalance(userId, current) {
				const newVal = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:', current)
				if (newVal === null) return

				try {
					const res = await fetch(`${API_URL}/admin/users/${userId}/balance`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ admin_tg_id: adminTgId, balance: newVal }),
					})
					if (res.ok) {
						tg.HapticFeedback.notificationOccurred('success')
						loadUsers()
					}
				} catch (e) {
					alert('–û—à–∏–±–∫–∞')
				}
			}

			async function deletePollution(id) {
				if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞?')) return

				try {
					const res = await fetch(
						`${API_URL}/admin/pollutions/${id}?admin_tg_id=${adminTgId}`,
						{
							method: 'DELETE',
						},
					)
					if (res.ok) {
						tg.HapticFeedback.notificationOccurred('success')
						loadPollutions()
					}
				} catch (e) {
					alert('–û—à–∏–±–∫–∞')
				}
			}

			// Initial load
			loadUsers()
		</script>
	</body>
</html>
