<!doctype html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
		/>
		<title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å EcoPatrol</title>
		<script src="https://telegram.org/js/telegram-web-app.js"></script>
		<style>
			:root {
				--primary: #10b981;
				--primary-dark: #059669;
				--bg-primary: #f9fafb;
				--bg-secondary: #ffffff;
				--text-primary: #111827;
				--text-secondary: #4b5563;
				--border: #e5e7eb;
				--card-shadow:
					0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
				--safe-top: env(safe-area-inset-top);
			}

			[data-theme='dark'] {
				--bg-primary: #111827;
				--bg-secondary: #1f2937;
				--text-primary: #f9fafb;
				--text-secondary: #9ca3af;
				--border: #374151;
				--card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
			}

			* {
				box-sizing: border-box;
				-webkit-tap-highlight-color: transparent;
			}

			body {
				font-family:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica,
					Arial, sans-serif;
				background-color: var(--bg-primary);
				color: var(--text-primary);
				margin: 0;
				padding: calc(var(--safe-top) + 20px) 16px 40px;
				transition:
					background-color 0.3s,
					color 0.3s;
				line-height: 1.5;
			}

			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 24px;
				padding: 0 4px;
			}

			.header h1 {
				font-size: 24px;
				font-weight: 800;
				margin: 0;
				background: linear-gradient(135deg, var(--primary), #3b82f6);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
			}

			.theme-toggle {
				width: 40px;
				height: 40px;
				border-radius: 12px;
				background: var(--bg-secondary);
				border: 1px solid var(--border);
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				box-shadow: var(--card-shadow);
			}

			.tabs {
				display: flex;
				background: var(--bg-secondary);
				padding: 4px;
				border-radius: 14px;
				margin-bottom: 20px;
				border: 1px solid var(--border);
				box-shadow: var(--card-shadow);
			}

			.tab-btn {
				flex: 1;
				padding: 10px;
				border: none;
				border-radius: 10px;
				background: transparent;
				color: var(--text-secondary);
				font-weight: 600;
				font-size: 13px;
				transition: all 0.2s;
				cursor: pointer;
			}

			.tab-btn.active {
				background: var(--primary);
				color: white;
				box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
			}

			.section {
				display: none;
				animation: fadeIn 0.3s ease;
			}
			.section.active {
				display: block;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.card {
				background: var(--bg-secondary);
				border-radius: 18px;
				padding: 18px;
				margin-bottom: 16px;
				border: 1px solid var(--border);
				box-shadow: var(--card-shadow);
				position: relative;
				overflow: hidden;
			}

			.card::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				width: 4px;
				height: 100%;
				background: var(--primary);
				opacity: 0.5;
			}

			.card-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: 12px;
			}

			.user-info .name {
				font-weight: 700;
				font-size: 17px;
				margin-bottom: 2px;
			}

			.user-info .meta {
				font-size: 12px;
				color: var(--text-secondary);
				font-weight: 500;
				display: flex;
				flex-direction: column;
				gap: 2px;
			}

			.badge-balance {
				background: rgba(16, 185, 129, 0.1);
				color: var(--primary);
				padding: 4px 10px;
				border-radius: 20px;
				font-weight: 700;
				font-size: 14px;
			}

			.btn-group {
				display: flex;
				gap: 10px;
				margin-top: 12px;
			}

			.btn {
				flex: 1;
				padding: 12px;
				border: none;
				border-radius: 12px;
				font-weight: 700;
				font-size: 13px;
				cursor: pointer;
				transition:
					transform 0.1s,
					opacity 0.2s;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 6px;
			}

			.btn:active {
				transform: scale(0.97);
			}
			.btn-primary {
				background: var(--primary);
				color: white;
			}
			.btn-secondary {
				background: var(--bg-primary);
				color: var(--text-primary);
				border: 1px solid var(--border);
			}
			.btn-danger {
				background: rgba(239, 68, 68, 0.1);
				color: #ef4444;
				border: 1px solid rgba(239, 68, 68, 0.2);
			}

			.settings-grid {
				display: flex;
				flex-direction: column;
				gap: 16px;
			}

			.setting-item {
				background: var(--bg-secondary);
				padding: 16px;
				border-radius: 16px;
				border: 1px solid var(--border);
			}

			.setting-label {
				font-size: 13px;
				font-weight: 700;
				color: var(--text-secondary);
				margin-bottom: 8px;
				display: block;
			}

			.setting-input {
				width: 100%;
				padding: 12px;
				border-radius: 12px;
				border: 1.5px solid var(--border);
				background: var(--bg-primary);
				color: var(--text-primary);
				font-weight: 600;
				font-size: 16px;
			}

			.loading-state {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				padding: 60px 20px;
				opacity: 0.5;
			}

			.spinner {
				width: 30px;
				height: 30px;
				border: 3px solid var(--border);
				border-top-color: var(--primary);
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin-bottom: 12px;
			}
			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
			<div class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</div>
		</div>

		<div class="tabs">
			<button
				class="tab-btn active"
				id="tab-users"
				onclick="switchTab('users')"
			>
				–õ—é–¥–∏
			</button>
			<button
				class="tab-btn"
				id="tab-pollutions"
				onclick="switchTab('pollutions')"
			>
				–ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è
			</button>
			<button class="tab-btn" id="tab-settings" onclick="switchTab('settings')">
				–ù–∞—Å—Ç—Ä–æ–π–∫–∏
			</button>
		</div>

		<div id="section-users" class="section active">
			<div id="users-list"></div>
		</div>

		<div id="section-pollutions" class="section">
			<div id="pollutions-list"></div>
		</div>

		<div id="section-settings" class="section">
			<div class="settings-grid">
				<div class="setting-item">
					<label class="setting-label">–ù–∞–≥—Ä–∞–¥–∞: –£—Ä–æ–≤–µ–Ω—å 1 (–ù–∏–∑–∫–∏–π)</label>
					<input
						type="number"
						id="setting-reward-1"
						class="setting-input"
						step="0.5"
					/>
				</div>
				<div class="setting-item">
					<label class="setting-label">–ù–∞–≥—Ä–∞–¥–∞: –£—Ä–æ–≤–µ–Ω—å 2 (–°—Ä–µ–¥–Ω–∏–π)</label>
					<input
						type="number"
						id="setting-reward-2"
						class="setting-input"
						step="0.5"
					/>
				</div>
				<div class="setting-item">
					<label class="setting-label">–ù–∞–≥—Ä–∞–¥–∞: –£—Ä–æ–≤–µ–Ω—å 3 (–í—ã—Å–æ–∫–∏–π)</label>
					<input
						type="number"
						id="setting-reward-3"
						class="setting-input"
						step="0.5"
					/>
				</div>
				<button
					class="btn btn-primary"
					style="margin-top: 10px"
					onclick="saveSettings()"
				>
					üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
				</button>
			</div>
		</div>

		<script>
			const tg = window.Telegram.WebApp
			tg.expand()
			const API_URL = window.location.origin + '/api'
			const urlParams = new URLSearchParams(window.location.search)
			const adminTgId = urlParams.get('admin_tg_id')

			let currentTheme =
				localStorage.getItem('admin-theme') || tg.colorScheme || 'light'
			applyTheme(currentTheme)

			function applyTheme(theme) {
				document.documentElement.setAttribute('data-theme', theme)
				localStorage.setItem('admin-theme', theme)
				document.getElementById('theme-btn').innerHTML =
					theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'
				tg.setHeaderColor(theme === 'dark' ? '#111827' : '#f9fafb')
			}

			function toggleTheme() {
				currentTheme = currentTheme === 'dark' ? 'light' : 'dark'
				applyTheme(currentTheme)
				tg.HapticFeedback.impactOccurred('light')
			}

			function switchTab(tab) {
				document
					.querySelectorAll('.section')
					.forEach(s => s.classList.remove('active'))
				document
					.querySelectorAll('.tab-btn')
					.forEach(b => b.classList.remove('active'))
				document.getElementById('section-' + tab).classList.add('active')
				document.getElementById('tab-' + tab).classList.add('active')
				tg.HapticFeedback.impactOccurred('light')
				if (tab === 'users') loadUsers()
				if (tab === 'pollutions') loadPollutions()
				if (tab === 'settings') loadSettings()
			}

			async function loadUsers() {
				const list = document.getElementById('users-list')
				list.innerHTML =
					'<div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>'
				try {
					const res = await fetch(
						`${API_URL}/admin/users?admin_tg_id=${adminTgId}`,
					)
					const users = await res.json()
					list.innerHTML = users
						.map(
							u => `
                    <div class="card">
                        <div class="card-header">
                            <div class="user-info">
                                <div class="name">${u.first_name} ${u.last_name || ''}</div>
                                <div class="meta">
                                    <span>@${u.username || 'unknown'} ‚Ä¢ ID: ${u.telegram_id}</span>
                                    <span>üì± ${u.phone || '–ù–µ—Ç –Ω–æ–º–µ—Ä–∞'} ‚Ä¢ üéÇ –í–æ–∑—Ä–∞—Å—Ç: ${u.age || '?'}</span>
                                </div>
                            </div>
                            <div class="badge-balance">$${u.balance.toFixed(2)}</div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="editBalance(${u.id}, ${u.balance}, '${u.first_name}')">üí∞ –ë–∞–ª–∞–Ω—Å</button>
                        </div>
                    </div>
                `,
						)
						.join('')
				} catch (e) {
					list.innerHTML = '<div class="loading-state">‚ùå –û—à–∏–±–∫–∞</div>'
				}
			}

			async function loadPollutions() {
				const list = document.getElementById('pollutions-list')
				list.innerHTML =
					'<div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–æ–∫...</div>'
				try {
					const res = await fetch(
						`${API_URL}/admin/pollutions?admin_tg_id=${adminTgId}`,
					)
					const pollutions = await res.json()
					list.innerHTML = pollutions
						.map(
							p => `
                    <div class="card">
                        <div class="card-header">
                            <div class="user-info">
                                <div class="name">–ú–µ—Ç–∫–∞ #${p.id}</div>
                                <div class="meta">–°—Ç–∞—Ç—É—Å: ${p.status} ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: ${p.level} ‚Ä¢ <b>–ù–∞–≥—Ä–∞–¥–∞: $${p.reward}</b></div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="editReward(${p.id}, ${p.reward})">üíé –ò–∑–º. –Ω–∞–≥—Ä–∞–¥—É</button>
                            <button class="btn btn-danger" onclick="deletePollution(${p.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `,
						)
						.join('')
				} catch (e) {
					list.innerHTML = '<div class="loading-state">‚ùå –û—à–∏–±–∫–∞</div>'
				}
			}

			async function loadSettings() {
				try {
					const res = await fetch(
						`${API_URL}/admin/settings?admin_tg_id=${adminTgId}`,
					)
					const settings = await res.json()
					document.getElementById('setting-reward-1').value =
						settings.reward_level_1 || 1
					document.getElementById('setting-reward-2').value =
						settings.reward_level_2 || 2
					document.getElementById('setting-reward-3').value =
						settings.reward_level_3 || 3
				} catch (e) {
					alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫')
				}
			}

			async function saveSettings() {
				const settings = {
					reward_level_1: document.getElementById('setting-reward-1').value,
					reward_level_2: document.getElementById('setting-reward-2').value,
					reward_level_3: document.getElementById('setting-reward-3').value,
				}
				try {
					const res = await fetch(`${API_URL}/admin/settings`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ admin_tg_id: adminTgId, settings }),
					})
					if (res.ok) {
						tg.HapticFeedback.notificationOccurred('success')
						tg.showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!')
					}
				} catch (e) {
					alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
				}
			}

			async function editReward(pId, current) {
				const newVal = prompt('–ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ —ç—Ç–æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ:', current)
				if (newVal === null || isNaN(newVal)) return
				try {
					const res = await fetch(`${API_URL}/admin/pollutions/${pId}/reward`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							admin_tg_id: adminTgId,
							reward: parseFloat(newVal),
						}),
					})
					if (res.ok) {
						loadPollutions()
						tg.HapticFeedback.notificationOccurred('success')
					}
				} catch (e) {
					alert('–û—à–∏–±–∫–∞')
				}
			}

			async function editBalance(userId, current, name) {
				const newVal = prompt(`–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è ${name}:`, current)
				if (newVal === null || isNaN(newVal)) return
				try {
					const res = await fetch(`${API_URL}/admin/users/${userId}/balance`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							admin_tg_id: adminTgId,
							balance: parseFloat(newVal),
						}),
					})
					if (res.ok) {
						loadUsers()
						tg.HapticFeedback.notificationOccurred('success')
					}
				} catch (e) {
					alert('–û—à–∏–±–∫–∞')
				}
			}

			async function deletePollution(id) {
				if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return
				try {
					const res = await fetch(
						`${API_URL}/admin/pollutions/${id}?admin_tg_id=${adminTgId}`,
						{ method: 'DELETE' },
					)
					if (res.ok) {
						loadPollutions()
						tg.HapticFeedback.notificationOccurred('success')
					}
				} catch (e) {
					alert('–û—à–∏–±–∫–∞')
				}
			}

			loadUsers()
		</script>
	</body>
</html>
