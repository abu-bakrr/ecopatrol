<!doctype html>
<html lang="ru" data-theme="light">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content"
		/>
		<title>–≠–∫–æ–ø–∞—Ç—Ä—É–ª—å</title>

		<!-- MapLibre -->
		<link
			href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>

		<!-- Telegram -->
		<script src="https://telegram.org/js/telegram-web-app.js"></script>

		<script>
			// INSTANT THEME DETECTION: Apply theme before body renders
			;(function () {
				const tg = window.Telegram ? window.Telegram.WebApp : null
				const savedTheme = localStorage.getItem('theme')
				const theme = savedTheme || (tg && tg.colorScheme) || 'light'
				document.documentElement.setAttribute('data-theme', theme)
				// Set background immediately to prevent flash (EXACT map-bg match)
				const bgColor = theme === 'dark' ? '#242f3e' : '#fcfcfc'
				document.write(
					'<style>html, body { background: ' +
						bgColor +
						' !important; }</style>',
				)
			})()
		</script>

		<link rel="stylesheet" href="style.css?v=1090" />
		<style>
			/* Critical styles for startup stability */
			#debug-console {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(17, 24, 39, 0.95) !important;
				color: #ffffff !important;
				z-index: 2000000 !important;
				padding: 60px 20px 20px;
				font-family: monospace;
				font-size: 11px;
				overflow-y: auto;
				display: none;
				flex-direction: column;
				pointer-events: auto !important;
			}
			#debug-console.active {
				display: flex !important;
			}
			#debug-toggle-btn {
				display: none; /* Controlled by JS based on admin setting */
				z-index: 2000001 !important;
				opacity: 0.8;
				background: #ef4444 !important;
				color: white !important;
				position: fixed;
				bottom: 110px;
				right: 12px;
				border: none;
				padding: 8px 12px;
				border-radius: 12px;
				font-weight: 800;
				font-size: 10px;
				pointer-events: auto !important;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			}
		</style>
	</head>
	<body>
		<!-- Onboarding Screen -->
		<div class="onboarding hidden" id="onboarding">
			<div class="onboarding-content">
				<div class="onboarding-icon">
					<svg
						width="56"
						height="56"
						viewBox="0 0 24 24"
						fill="none"
						stroke="white"
						stroke-width="2"
					>
						<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
						<circle cx="12" cy="10" r="3" />
					</svg>
				</div>
				<h1 class="onboarding-title" data-t="app_title">–≠–∫–æ–ø–∞—Ç—Ä—É–ª—å</h1>
				<p class="onboarding-subtitle" data-t="onboarding_subtitle">
					–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
				</p>

				<form id="onboarding-form" style="width: 100%">
					<div class="form-group">
						<label class="form-label" data-t="form_name">–ò–º—è</label>
						<input
							type="text"
							class="form-input"
							id="first-name"
							placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"
							data-t-placeholder="form_placeholder_name"
							autocomplete="given-name"
							required
						/>
					</div>

					<div class="form-group">
						<label class="form-label" data-t="form_surname">–§–∞–º–∏–ª–∏—è</label>
						<input
							type="text"
							class="form-input"
							id="last-name"
							placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é"
							data-t-placeholder="form_placeholder_surname"
							autocomplete="family-name"
							required
						/>
					</div>

					<div class="form-group">
						<label class="form-label" data-t="form_age">–í–æ–∑—Ä–∞—Å—Ç</label>
						<input
							type="number"
							class="form-input"
							id="age"
							placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç"
							data-t-placeholder="form_placeholder_age"
							min="13"
							max="120"
							inputmode="numeric"
							required
						/>
					</div>

					<div class="form-group">
						<label class="form-label" data-t="form_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
						<input
							type="tel"
							class="form-input"
							id="phone"
							placeholder="+998 (__) ___-__-__"
							autocomplete="tel"
							inputmode="tel"
							required
						/>
					</div>
				</form>

				<button
					type="submit"
					class="btn btn-primary"
					form="onboarding-form"
					id="submit-onboarding"
					style="width: 100%; margin-top: 16px; margin-bottom: 24px"
				>
					–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
				</button>
			</div>
		</div>

		<!-- Offline Overlay -->
		<div id="offline-overlay" class="global-overlay hidden">
			<div class="overlay-content" style="border-top: 4px solid #6b7280">
				<div
					class="overlay-glow"
					style="
						background: radial-gradient(
							circle at center,
							rgba(107, 114, 128, 0.15) 0%,
							transparent 50%
						);
					"
				></div>
				<div
					class="overlay-icon"
					style="
						background: #6b7280;
						box-shadow: 0 10px 25px rgba(107, 114, 128, 0.4);
					"
				>
					<svg
						width="40"
						height="40"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2.5"
					>
						<path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55" />
						<path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" />
						<path d="M10.71 5.05A16 16 0 0 1 22.58 9" />
						<path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" />
						<path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
						<path d="M12 20h.01" />
					</svg>
				</div>
				<h2 class="overlay-title" data-t="offline_title">–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞</h2>
				<p class="overlay-text" data-t="offline_text">
					–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
					–∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏.
				</p>
			</div>
		</div>

		<!-- Global Blocking Overlay (Location) -->
		<div id="location-blocked-overlay" class="global-overlay hidden">
			<div class="overlay-content">
				<div class="overlay-glow"></div>
				<div class="overlay-icon">
					<svg
						width="40"
						height="40"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2.5"
						stroke-linecap="round"
						stroke-linejoin="round"
					>
						<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
						<circle cx="12" cy="10" r="3" />
					</svg>
				</div>
				<h2 class="overlay-title" data-t="location_help_title">
					–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø
				</h2>
				<p class="overlay-text" data-t="location_help_text">
					–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤
					–Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –∏ –≤–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏.
				</p>
				<button class="btn btn-overlay" id="retry-geo-btn-global">
					<span data-t="location_retry_btn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</span>
				</button>
			</div>
		</div>

		<!-- Map -->
		<div id="map">
			<!-- Map Loading Overlay (Pure Shimmer) -->
			<div id="map-loading-overlay" class="map-loading-overlay">
				<div class="shimmer-wave"></div>
			</div>
		</div>

		<!-- Center Marker -->
		<div class="center-marker" id="center-marker">
			<svg width="32" height="40" viewBox="0 0 32 40" fill="none">
				<path
					d="M16 0C7.163 0 0 7.163 0 16c0 11.2 16 24 16 24s16-12.8 16-24C32 7.163 24.837 0 16 0z"
					fill="#059669"
				/>
				<circle cx="16" cy="16" r="6" fill="white" />
			</svg>
		</div>

		<!-- Profile Button -->
		<button class="profile-btn" id="profile-btn">
			<svg
				width="20"
				height="20"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
			>
				<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
				<circle cx="12" cy="7" r="4" />
			</svg>
		</button>

		<button class="balance-btn" id="balance-btn">
			<svg
				width="20"
				height="20"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
			>
				<path d="M3 6h18" />
				<path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
				<path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
			</svg>
		</button>

		<!-- Visibility Toggle Button -->
		<button class="toggle-pollutions-btn" id="toggle-pollutions-btn">
			<svg
				width="20"
				height="20"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
				id="toggle-icon"
			>
				<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
				<circle cx="12" cy="12" r="3" />
			</svg>
		</button>

		<!-- Geolocation Button (Right) -->
		<button class="geolocate-btn" id="geolocate-btn">
			<svg
				width="20"
				height="20"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
			>
				<path d="M12 2v4m0 12v4M2 12h4m12 0h4" />
				<circle cx="12" cy="12" r="3" />
			</svg>
		</button>

		<!-- Add Pollution Button -->
		<button class="add-btn" id="add-btn">
			<svg
				width="24"
				height="24"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2.5"
			>
				<path d="M12 5v14M5 12h14" />
			</svg>
		</button>

		<!-- Sidebar (Profile) -->
		<div class="sidebar" id="sidebar">
			<div class="sidebar-header">
				<div class="profile-main">
					<div class="profile-avatar" id="sidebar-avatar">--</div>
					<div class="user-info">
						<div class="user-name" id="sidebar-username">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
						<div class="user-id" id="sidebar-userid">ID: ...</div>
					</div>
				</div>
				<button class="theme-icon-btn" id="theme-toggle">
					<svg
						id="theme-icon"
						width="22"
						height="22"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
					>
						<!-- Sun icon (Light mode default) -->
						<circle cx="12" cy="12" r="5" />
						<line x1="12" y1="1" x2="12" y2="3" />
						<line x1="12" y1="21" x2="12" y2="23" />
						<line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
						<line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
						<line x1="1" y1="12" x2="3" y2="12" />
						<line x1="21" y1="12" x2="23" y2="12" />
						<line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
						<line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
					</svg>
				</button>
			</div>

			<div class="sidebar-content">
				<!-- Stats Grid Section -->
				<div class="stats-grid">
					<div class="stat-item">
						<div class="stat-icon balance">
							<svg
								width="20"
								height="20"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
							>
								<circle cx="12" cy="12" r="10" />
								<path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8" />
								<path d="M12 18V6" />
							</svg>
						</div>
						<div class="stat-info">
							<div class="stat-value" id="sidebar-balance">0 UZS</div>
							<div class="stat-label" data-t="balance">–ë–∞–ª–∞–Ω—Å</div>
						</div>
					</div>
					<div class="stat-item">
						<div class="stat-icon cleaned">
							<svg
								width="20"
								height="20"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
							>
								<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
								<polyline points="22 4 12 14.01 9 11.01" />
							</svg>
						</div>
						<div class="stat-info">
							<div class="stat-value" id="sidebar-cleaned">0</div>
							<div class="stat-label" data-t="cleaned">–û—á–∏—â–µ–Ω–æ</div>
						</div>
					</div>
				</div>

				<!-- Language Switcher Section -->
				<div class="language-switcher">
					<div class="lang-option" onclick="window.setLanguage('uz')">
						üá∫üáø UZ
					</div>
					<div class="lang-option" onclick="window.setLanguage('ru')">
						üá∑üá∫ RU
					</div>
					<div class="lang-option" onclick="window.setLanguage('en')">
						üá¨üáß EN
					</div>
				</div>

				<!-- Menu List Section -->
				<div class="action-menu">
					<div class="menu-item" id="menu-exchange">
						<svg
							width="18"
							height="18"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
						>
							<path d="M3 6h18" />
							<path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
							<path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
						</svg>
						<span data-t="menu_pollutions">–ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è</span>
					</div>
					<div class="menu-item" id="menu-reports">
						<svg
							width="18"
							height="18"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<path
								d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
							/>
							<polyline points="14 2 14 8 20 8" />
							<line x1="16" y1="13" x2="8" y2="13" />
							<line x1="16" y1="17" x2="8" y2="17" />
							<polyline points="10 9 9 9 8 9" />
						</svg>
						<span data-t="menu_reports">–ú–æ–∏ –æ—Ç—á–µ—Ç—ã</span>
					</div>
					<div class="menu-item" id="menu-history">
						<svg
							width="18"
							height="18"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<circle cx="12" cy="12" r="10" />
							<polyline points="12 6 12 12 16 14" />
						</svg>
						<span data-t="menu_history">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</span>
					</div>
					<div class="menu-item" id="menu-leaderboard">
						<svg
							width="18"
							height="18"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
							<path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
							<path d="M4 22h16" />
							<path
								d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"
							/>
							<path
								d="M14 14.66V17c0 .55.45.98.97 1.21C16.15 18.75 17 20.24 17 22"
							/>
							<path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
						</svg>
						<span data-t="menu_leaderboard">–†–µ–π—Ç–∏–Ω–≥</span>
					</div>
					<div class="menu-item" id="menu-info">
						<svg
							width="18"
							height="18"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<circle cx="12" cy="12" r="10" />
							<line x1="12" y1="16" x2="12" y2="12" />
							<line x1="12" y1="8" x2="12.01" y2="8" />
						</svg>
						<span data-t="menu_info">–û –ø—Ä–æ–µ–∫—Ç–µ</span>
					</div>
				</div>

				<div class="sidebar-footer" id="sidebar-footer" data-t="sidebar_footer">
					EcoPatrol v36.0 ‚Ä¢ –°–¥–µ–ª–∞–µ–º –º–∏—Ä —á–∏—â–µ
				</div>
			</div>
		</div>

		<!-- Bottom Sheet -->
		<div class="bottom-sheet" id="bottom-sheet">
			<div class="sheet-handle"></div>
			<div class="sheet-content" id="sheet-content">
				<!-- Dynamic content -->
			</div>
		</div>

		<!-- Overlay -->
		<div class="top-vignette"></div>
		<div class="bottom-vignette"></div>
		<div class="overlay" id="overlay"></div>

		<!-- Photo Viewer (Lightbox) -->
		<div
			id="photo-viewer"
			class="photo-viewer"
			onclick="window.closePhotoViewer()"
		>
			<div class="close-viewer" onclick="window.closePhotoViewer()">√ó</div>
			<img
				src=""
				id="viewer-img"
				class="viewer-img"
				onclick="event.stopPropagation()"
			/>
		</div>

		<!-- Debug Console Structure -->
		<button id="debug-toggle-btn">üêû LOGS</button>
		<div id="debug-console"></div>

		<!-- Error Handler for Mobile Debugging -->
		<script>
			// Simple on-screen logger
			const debugConsole = document.getElementById('debug-console')
			const debugBtn = document.getElementById('debug-toggle-btn')

			debugBtn.addEventListener('click', () => {
				debugConsole.classList.toggle('active')
			})

			function logToScreen(msg, type = 'log') {
				// SILENCE NETWORK ERRORS WHEN OFFLINE
				const msgStr = String(msg).toLowerCase()
				if (
					!navigator.onLine &&
					(msgStr.includes('fetch') ||
						msgStr.includes('load failed') ||
						msgStr.includes('networkerror'))
				) {
					return
				}

				const line = document.createElement('div')
				line.style.borderBottom = '1px solid #333'
				line.style.padding = '2px 0'
				line.style.wordBreak = 'break-all'

				if (type === 'error') line.style.color = '#ff5555'
				else if (type === 'warn') line.style.color = '#ffff55'

				line.textContent = `[${new Date().toLocaleTimeString()}] ${String(msg)}`
				debugConsole.appendChild(line)
				debugConsole.scrollTop = debugConsole.scrollHeight
			}

			// Capture Global Errors
			window.onerror = function (msg, url, line) {
				logToScreen(`Global Error: ${msg} \nLine: ${line}`, 'error')

				// ONLY AUTO-OPEN IF ONLINE AND ADMIN ENABLED LOGS
				if (navigator.onLine && debugBtn.style.display !== 'none') {
					debugConsole.classList.add('active')
				}
				return false
			}

			// Global Click Tracker
			document.addEventListener(
				'click',
				e => {
					logToScreen(`Click: ${e.target.tagName} .${e.target.className}`)
				},
				true,
			)

			// Override Console
			const originalLog = console.log
			const originalError = console.error
			const originalWarn = console.warn

			console.log = function (...args) {
				originalLog.apply(console, args)
				logToScreen(args.join(' '))
			}

			console.error = function (...args) {
				originalError.apply(console, args)
				logToScreen(args.join(' '), 'error')

				// ONLY AUTO-OPEN IF ONLINE AND ADMIN ENABLED LOGS
				if (navigator.onLine && debugBtn.style.display !== 'none') {
					debugConsole.classList.add('active')
				}
			}

			console.warn = function (...args) {
				originalWarn.apply(console, args)
				logToScreen(args.join(' '), 'warn')
			}

			console.log('Log system ready v1060')
		</script>

		<script src="translations.js?v=1090"></script>
		<script type="module" src="main.js?v=1090"></script>
	</body>
</html>
